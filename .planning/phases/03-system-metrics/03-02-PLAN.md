---
phase: 03-system-metrics
plan: 02
type: execute
wave: 2
depends_on:
  - 03-01
files_modified:
  - internal/db/maintenance.go
  - internal/db/maintenance_test.go
  - internal/app/runtime.go
autonomous: true
requirements:
  - STOR-06
  - STOR-07
must_haves:
  truths:
    - "Cleanup loop deletes old synced rows when thresholds are exceeded."
    - "WAL checkpoint loop runs periodically and triggers RESTART above threshold."
  artifacts:
    - path: "internal/db/maintenance.go"
      provides: "cleanup + wal checkpoint controls"
    - path: "internal/db/maintenance_test.go"
      provides: "maintenance behavior tests"
  key_links:
    - from: "internal/app/runtime.go"
      to: "internal/db/maintenance.go"
      via: "background cleanup/checkpoint loop calls"
      pattern: "CleanupOldSynced|CheckpointIfWALExceeds"
---

<objective>
Add database maintenance loops for cleanup and WAL control to keep storage healthy under sustained operation.
</objective>

<tasks>
<task type="auto">
  <name>Task 1: Implement cleanup and WAL maintenance primitives</name>
  <files>internal/db/maintenance.go</files>
  <action>Add DB-size/disk-threshold cleanup and conditional RESTART WAL checkpoint methods.</action>
  <verify>`go test ./internal/db -v` passes with maintenance tests.</verify>
  <done>DB maintenance API supports STOR-06/STOR-07.</done>
</task>
<task type="auto">
  <name>Task 2: Add maintenance tests</name>
  <files>internal/db/maintenance_test.go</files>
  <action>Add tests for forced-threshold cleanup deletions and WAL checkpoint trigger behavior.</action>
  <verify>Test output confirms cleanup executes and checkpoint triggers when threshold exceeded.</verify>
  <done>Maintenance behavior is regression-protected.</done>
</task>
<task type="auto">
  <name>Task 3: Wire maintenance loops into runtime background lifecycle</name>
  <files>internal/app/runtime.go</files>
  <action>Start cleanup and WAL checkpoint tickers with config-controlled intervals and cancellation on shutdown.</action>
  <verify>`go test ./...` and linux static build pass.</verify>
  <done>Runtime includes active storage maintenance loops.</done>
</task>
</tasks>

<output>
After completion, create `.planning/phases/03-system-metrics/03-02-SUMMARY.md`
</output>
