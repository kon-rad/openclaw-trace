---
phase: 03-system-metrics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/config/config.go
  - internal/metrics/collector.go
  - internal/ingest/types.go
  - internal/ingest/worker.go
  - internal/app/runtime.go
  - internal/db/insert.go
autonomous: true
requirements:
  - SYSM-01
  - SYSM-02
  - SYSM-03
  - SYSM-04
  - SYSM-05
  - SYSM-06
must_haves:
  truths:
    - "Runtime collects metrics on configured interval and feeds ingest queue."
    - "CPU and memory are read from cgroup paths."
    - "First CPU sample is discarded."
    - "Metrics rows persist in system_metrics table."
  artifacts:
    - path: "internal/metrics/collector.go"
      provides: "cgroup-aware metrics collector"
    - path: "internal/ingest/worker.go"
      provides: "metric event persistence via existing batch path"
  key_links:
    - from: "internal/metrics/collector.go"
      to: "internal/app/runtime.go"
      via: "background loop startup and enqueue"
      pattern: "Run\\("
---

<objective>
Add cgroup-aware system metrics collection and ingest integration so host health data is captured in SQLite alongside LLM traces/errors.
</objective>

<tasks>
<task type="auto">
  <name>Task 1: Implement metrics collector and cgroup sampling</name>
  <files>internal/metrics/collector.go, internal/config/config.go</files>
  <action>Implement periodic collection (default 15s), cgroup CPU/memory sampling, disk usage, and process I/O rates with first CPU sample discard behavior.</action>
  <verify>`go test ./...` passes and collector compiles with Linux cgroup paths.</verify>
  <done>Collector emits metric payloads and satisfies SYSM-01..06 semantics in code.</done>
</task>
<task type="auto">
  <name>Task 2: Extend ingest+DB path for system metric events</name>
  <files>internal/ingest/types.go, internal/ingest/worker.go, internal/db/insert.go</files>
  <action>Add metric event kind and batch insert support into `system_metrics` table without introducing extra DB writers.</action>
  <verify>`go test ./...` passes with metric inserts included in batch transactions.</verify>
  <done>Metrics are persisted through the same single-writer path as traces/errors.</done>
</task>
<task type="auto">
  <name>Task 3: Wire collector loop into runtime lifecycle</name>
  <files>internal/app/runtime.go</files>
  <action>Start/stop collector goroutine with runtime lifecycle and ensure graceful shutdown cancellation.</action>
  <verify>Runtime builds and test suite passes after collector integration.</verify>
  <done>Metrics collection runs as managed background loop.</done>
</task>
</tasks>

<output>
After completion, create `.planning/phases/03-system-metrics/03-01-SUMMARY.md`
</output>
