---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on:
  - 01-01
files_modified:
  - internal/db/db.go
  - internal/db/schema.go
  - internal/app/runtime.go
  - cmd/openclaw-trace/main.go
  - README.md
autonomous: true
requirements:
  - FOUN-03
  - STOR-01
  - STOR-02
  - STOR-05
must_haves:
  truths:
    - "Service opens SQLite at OCT_DB_PATH and applies WAL + required pragmas."
    - "All four required tables exist after startup."
    - "SIGTERM shuts down cleanly with WAL checkpoint and DB close."
  artifacts:
    - path: "internal/db/db.go"
      provides: "SQLite open, pragma application, health stats access"
    - path: "internal/db/schema.go"
      provides: "DDL for llm_traces, error_events, system_metrics, push_log and indexes"
    - path: "internal/app/runtime.go"
      provides: "Graceful shutdown choreography"
  key_links:
    - from: "cmd/openclaw-trace/main.go"
      to: "internal/db/db.go"
      via: "startup DB initialization"
      pattern: "Open"
    - from: "internal/app/runtime.go"
      to: "internal/db/db.go"
      via: "shutdown WAL checkpoint and close"
      pattern: "wal_checkpoint"
---

<objective>
Complete the Foundation phase by implementing SQLite initialization/schema and graceful SIGTERM shutdown semantics on top of the service skeleton from Plan 01.

Purpose: Lock in correctness-by-construction for storage and lifecycle so later ingest/push phases do not require architectural rewrites.
Output: Runtime that starts with DB readiness, surfaces DB health details, and exits cleanly within bounded shutdown time.
</objective>

<execution_context>
@/Users/konradgnat/.claude/get-shit-done/workflows/execute-plan.md
@/Users/konradgnat/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement SQLite open path and schema DDL</name>
  <files>internal/db/db.go, internal/db/schema.go</files>
  <action>Add modernc.org/sqlite-backed DB bootstrap using configurable OCT_DB_PATH, apply required pragmas (journal_mode=WAL, busy_timeout=10000, auto_vacuum=INCREMENTAL, plus cache/synchronous settings from research), and create all required tables and `(synced, created_at)` indexes idempotently. Ensure schema column decisions from CONTEXT.md are followed (trace_id UUID text, unix ms timestamps, metadata text, synced+pushed_at on event tables).</action>
  <verify>Run service once and verify pragmas with sqlite queries: `PRAGMA journal_mode`, `PRAGMA busy_timeout`, `PRAGMA auto_vacuum`; verify table existence by querying sqlite_master for llm_traces/error_events/system_metrics/push_log.</verify>
  <done>STOR-01/STOR-02/STOR-05 are satisfied with startup DB initialization and deterministic schema creation.</done>
</task>

<task type="auto">
  <name>Task 2: Wire DB-backed health fields and startup status log</name>
  <files>cmd/openclaw-trace/main.go, internal/db/db.go, internal/server/health.go</files>
  <action>Integrate DB component into runtime bootstrap so /health reports db_status plus db/wal sizes from OCT_DB_PATH. Preserve always-200 contract while shifting status between ok/degraded based on DB file/connection state. Add startup log line confirming SQLite opened path + table count.</action>
  <verify>With DB path writable, `/health` reports `db_status=ok` and nonnegative sizes; with intentionally invalid DB path, process logs startup failure and exits predictably (or degraded status if design intentionally permits). Confirm behavior matches chosen startup contract.</verify>
  <done>Health endpoint now reflects real DB readiness and startup logs include DB init details.</done>
</task>

<task type="auto">
  <name>Task 3: Implement graceful shutdown and foundation smoke checks</name>
  <files>internal/app/runtime.go, cmd/openclaw-trace/main.go, README.md</files>
  <action>Add signal.NotifyContext shutdown flow: stop HTTP server, drain in-flight runtime work (queue placeholder in Phase 1), execute final WAL checkpoint, close DB handles, and exit within 15s. Emit required shutdown logs (signal received, drain progress, final stats). Add README section with quickstart env vars and verification commands for phase completion.</action>
  <verify>Start service, send SIGTERM, confirm clean exit code and shutdown log sequence. Re-open DB after exit and ensure file is readable. Run `CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build ./...` and verify no regression.</verify>
  <done>FOUN-03 is satisfied and Phase 1 success criteria can be demonstrated end-to-end.</done>
</task>

</tasks>

<verification>
- SQLite pragma assertions return expected values (`wal`, `10000`, `2`).
- Required tables exist immediately after startup.
- SIGTERM path exits cleanly and DB remains readable on next open.
</verification>

<success_criteria>
- [ ] STOR-01 implemented: DB path configurable and opened successfully.
- [ ] STOR-02 implemented: four tables + indexes created idempotently.
- [ ] STOR-05 implemented: required pragmas applied and validated.
- [ ] FOUN-03 implemented: bounded graceful shutdown with checkpoint/close sequence.
- [ ] Foundation phase can be marked ready for execution verification.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
